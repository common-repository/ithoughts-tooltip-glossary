{"version":3,"sources":["../src/ithoughts_tt_gl-updater.js"],"names":["selfCalling","ithoughts","$","qs","updater","iThoughtsTooltipGlossaryUpdater","pagenow","progress","text","initData","verboseArea","updaterSection","printError","error","data","stack","JSON","stringify","append","runUpdate","progression","post","iThoughtsTooltipGlossary","admin_ajax","action","versions","maxAdvancement","max","onUpdateRun","out","parentElement","scrollTop","scrollHeight","clientHeight","scrollValOld","value","innerHTML","parseInt","slice","verbose","i","j","length","parseHTML","type","from","targetversion","newversion","onUpdateDone","serverResponse","success","initUpdate","messageEnd","title","e","onUpdateInit","Error","Ended","postboxes","add_postbox_toggles","iThoughts","v5"],"mappings":"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","file":"ithoughts_tt_gl-updater.js","sourcesContent":["/**\n * @file Handles the dialog logic between server updates operations and client\n *\n * @author Gerkin\n * @copyright 2016 GerkinDevelopment\n * @license https://www.gnu.org/licenses/gpl-3.0.html GPLv3\n * @package ithoughts-tooltip-glossary\n *\n * @version 2.7.0\n */\n\n'use strict';\n\n/* global postboxes:false, iThoughtsTooltipGlossaryUpdater: false */\n\n( function selfCalling( ithoughts ) {\n\n\tvar $\t\t= ithoughts.$,\n\t\tqs\t\t= ithoughts.qs,\n\t\tupdater\t= iThoughtsTooltipGlossaryUpdater,\n\t\tpagenow\t= updater.pagenow,\n\t\tprogress,\n\t\ttext,\n\t\tinitData,\n\t\tverboseArea,\n\t\tupdaterSection;\n\tdelete updater.pagenow;\n\n\tfunction printError( error, data ) {\n\t\tverboseArea = `<div class=\"update-nag error\">\\\n<p>An error occured during the update. Please see below for details</p>\\\n</div>\\\n<div class=\"verboseContainer postbox\">\\\n<div class=\"handlediv\"></div><h4 class=\"hndle ui-sortable-handle\">Logs</h4>\\\n<div class=\"inside\">\\\n<pre class=\"verboseArea\">${ error.stack }\\\nResponse from server: ${ JSON.stringify( data, null, 4 ) }</pre>\\\n</div>\\\n</div>`;\n\t\tupdaterSection.append( verboseArea );\n\t}\n\n\tfunction runUpdate( progression ) {\n\t\t$.post( iThoughtsTooltipGlossary.admin_ajax, {\n\t\t\taction: 'ithoughts_tt_gl_update',\n\t\t\tdata:   {\n\t\t\t\tversions:       updater,\n\t\t\t\tprogression:    progression,\n\t\t\t\tmaxAdvancement: initData.max,\n\t\t\t},\n\t\t}, function onUpdateRun( out ) {\n\t\t\tif ( verboseArea.parentElement.scrollTop > ( verboseArea.parentElement.scrollHeight - verboseArea.parentElement.clientHeight ) - 50 ) {\n\t\t\t\tverboseArea.parentElement.scrollTop = verboseArea.parentElement.scrollHeight;\n\t\t\t}\n\t\t\tvar scrollValOld = ( verboseArea.parentElement.scrollHeight - verboseArea.parentElement.clientHeight );\n\t\t\ttry {\n\t\t\t\tprogress.value = out.data.progression;\n\t\t\t\ttext.innerHTML = `${ progress.value  }/${  initData.max  } (<em>${  ( `${ parseInt(( progress.value / initData.max ) * 100 )  }` ).slice( 0, 3 )  }%</em>)`;\n\t\t\t\tif ( out.data.verbose ) {\n\t\t\t\t\tfor ( var i = 0, j = out.data.verbose.length; i < j; i++ ) {\n\t\t\t\t\t\t$( verboseArea ).append( $.parseHTML( `<p class=\"${  out.data.verbose[i].type  }\">${  out.data.verbose[i].text  }</p>` ));\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif ( verboseArea.parentElement.scrollTop > scrollValOld - 50 ) {\n\t\t\t\t\tverboseArea.parentElement.scrollTop = verboseArea.parentElement.scrollHeight;\n\t\t\t\t}\n\t\t\t\tif ( out.data.progression < initData.max ) {\n\t\t\t\t\trunUpdate( out.data.progression );\n\t\t\t\t} else {\n\t\t\t\t\tupdater.from = initData.targetversion;\n\t\t\t\t\tithoughts.$.post( iThoughtsTooltipGlossary.admin_ajax, {\n\t\t\t\t\t\taction: 'ithoughts_tt_gl_update_done',\n\t\t\t\t\t\tdata:   {\n\t\t\t\t\t\t\tnewversion: updater.from,\n\t\t\t\t\t\t},\n\t\t\t\t\t}, function onUpdateDone( serverResponse ) {\n\t\t\t\t\t\tif ( serverResponse.success ) {\n\t\t\t\t\t\t\tinitUpdate( updater );\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tvar messageEnd = `<hr/><h4>${ out.data.title }</h4><p>${ out.data.text }</p>`;\n\t\t\t\t\t\t\tupdaterSection.append( messageEnd );\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t} catch ( e ) {\n\t\t\t\tprintError( e, out );\n\t\t\t}\n\t\t});\n\t}\n\n\tfunction initUpdate( versions ) {\n\t\t$.post( iThoughtsTooltipGlossary.admin_ajax, {\n\t\t\taction: 'ithoughts_tt_gl_update',\n\t\t\tdata:   {\n\t\t\t\tversions:       versions,\n\t\t\t\tprogression:    -1,\n\t\t\t\tmaxAdvancement: -1,\n\t\t\t},\n\t\t}, function onUpdateInit( out ) {\n\t\t\tupdaterSection = $( '#Updater' );\n\t\t\ttry {\n\t\t\t\tif ( 'undefined' === typeof out || 'undefined' === typeof out.data ) {\n\t\t\t\t\tthrow new Error( 'Empty server response' );\n\t\t\t\t}\n\t\t\t\tverboseArea = '<div class=\"verboseContainer postbox closed\"><div class=\"handlediv\" title=\"Cliquer pour inverser.\"></div><h4 class=\"hndle ui-sortable-handle\">Logs</h4><div class=\"inside\"><pre class=\"verboseArea\">';\n\t\t\t\tif ( out.data.verbose ) {\n\t\t\t\t\tfor ( var i = 0, j = out.data.verbose.length; i < j; i++ ) {\n\t\t\t\t\t\tverboseArea += `<p class=\"${  out.data.verbose[i].type  }\">${  out.data.verbose[i].text  }</p>`;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tverboseArea += '</pre></div></div>';\n\t\t\t\tif ( out.data.Ended ) {\n\t\t\t\t\tupdaterSection.append( $.parseHTML( `<article data-version=\"ended\"><h3>${  out.data.title  }</h3><p class=\"updatedescription\">${  out.data.text  }</p></article>` ));\n\t\t\t\t\tpostboxes.add_postbox_toggles( pagenow );\n\t\t\t\t} else {\n\t\t\t\t\tupdaterSection.append( $.parseHTML( `<article data-version=\"${  out.data.targetversion  }\"><h3>V${  out.data.targetversion  }</h3><p class=\"updatedescription\">${  out.data.text  }</p><progress class=\"updateprogress\" min=\"0\" max=\"${  out.data.max  }\" value=\"0\"></progress><span class=\"updateprogresstext\">0/${  out.data.max  } (<em>0%</em>)</span>${  verboseArea  }</article>` ));\n\t\t\t\t\tpostboxes.add_postbox_toggles( pagenow );\n\t\t\t\t\tinitData = out.data;\n\t\t\t\t\tprogress = qs( `[data-version=\"${  out.data.targetversion  }\"] .updateprogress` );\n\t\t\t\t\ttext = qs( `[data-version=\"${  out.data.targetversion  }\"] .updateprogresstext` );\n\t\t\t\t\tverboseArea = qs( `[data-version=\"${  out.data.targetversion  }\"] .verboseArea` );\n\n\t\t\t\t\trunUpdate( 0 );\n\t\t\t\t}\n\t\t\t} catch ( e ) {\n\t\t\t\tprintError( e, out );\n\t\t\t}\n\t\t});\n\t}\n\tinitUpdate( updater );\n})( iThoughts.v5 );\n"]}